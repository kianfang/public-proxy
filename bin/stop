#!/usr/bin/env node

const commander = require('commander');
const pm2 = require('pm2');
const pkg = require('../package.json');
const connectPM = require('../lib/connectPM');
const getProcessList = require('../lib/getProcessList');
const deleteProcess = require('../lib/deleteProcess');
const stopProcess = require('../lib/stopProcess');

let procName;

commander
    .version(pkg.version, '-v, --version')

    .option('-d, --delete', 'Stop and delete the instance.')

    .arguments('[name]')

    .action((name) => {
        // console.log(name);
        procName = name;
    })

;

commander.parse(process.argv);

if (procName) {
    connectPM()
        .then(getProcessList)
        .then((procDescs) => {
            if (
                // 停止全部实例
                procName === 'all' ||
                // 停止匹配实例
                procDescs.some(procDesc => procDesc.pm_id === parseInt(procName) || procDesc.name === procName)
            ) {
                return commander.delete ? deleteProcess(procName) : stopProcess(procName)
            } else {
                console.log(`Process ${procName} not exist.`);
                return Promise.resolve();
            }
        })
        .then(() => {
            pm2.disconnect();
            process.exit(0);
        })
        .catch((err) => {
            console.error(err);
            process.exit(1);
        });
} else {
    // 直接输出帮助说明
    commander.outputHelp();
}

