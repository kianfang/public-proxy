#!/usr/bin/env node

const path = require('path');
const pm2 = require('pm2');
const pkg = require('../package.json');
const connectPM = require('../lib/connectPM');
const getProcessList = require('../lib/getProcessList');
const deleteProcess = require('../lib/deleteProcess');
const printProcDescs = require('../lib/printProcDescs');
const throwError = require('../lib/throwError');
const readline = require('readline');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});


connectPM()
    .then(getProcessList)
    .then((procDescs) => {
        if (procDescs.some(procDesc => procDesc.name === pkg.name)) {
            return new Promise((resolve) => {
                // 已存在进程，与用户确认是否要杀掉进程
                rl.question(`The ${pkg.name} process will be killed ? (Y/n) `, (inputStr) => {
                    if (inputStr.toLowerCase() === 'y') {
                        deleteProcess(pkg.name).then(resolve);
                    } else {
                        console.log(`[Cancel] You can try restart script.`);
                        pm2.disconnect();
                        process.exit(0);
                    }
                });
            });

        }

        return Promise.resolve();
    })
    .then(() => {
        pm2.start({
            name: pkg.name,
            script: './index.js',
            args: process.argv.slice(2),
            cwd: path.resolve(__dirname, '../'),
            output: './logs/output.log',
            error: './logs/error.log',
            pid: `./logs/pid/${pkg.name}.pid`,
            exec_mode: 'cluster',
            instances: 2
        }, (err, procDescs) => {
            throwError(err);
            console.log(`[Success] server start successfully.`);
            pm2.disconnect();
            process.exit(0);
        });
    })
    .catch((err) => {
        console.error(err);
        process.exit(1);
    });
