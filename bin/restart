#!/usr/bin/env node

const commander = require('commander');
const pm2 = require('pm2');
const pkg = require('../package.json');
const connectPM = require('../lib/connectPM');
const getProcessList = require('../lib/getProcessList');
const reloadProcess = require('../lib/reloadProcess');
const printProcDescs = require('../lib/printProcDescs');

let procName;

commander
    .version(pkg.version, '-v, --version')

    .arguments('[name]')

    .action((name) => {
        // console.log(name);
        procName = name;
    })

;

commander.parse(process.argv);

if (procName) {
    connectPM()
        .then(getProcessList)
        .then((procDescs) => {
            if (
                // 重启全部实例
                procName === 'all' ||
                // 重启匹配实例
                procDescs.some(procDesc => procDesc.pm_id === parseInt(procName) || procDesc.name === procName)
            ) {
                return reloadProcess(procName);
            } else {
                console.log(`Process ${procName} not exist.`);
                return Promise.resolve();
            }
        })
        .then(() => {
            pm2.disconnect();
        })
        .catch((err) => {
            console.error(err);
            process.exit(1);
        });

} else {
    // 直接输出帮助说明
    commander.outputHelp();
}
